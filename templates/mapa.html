{% extends "layouts/base.html" %}

{% block title %}Mapa de Cobertura · ATX Coverage{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/map.css') }}">
{% endblock %}

{% block content %}
<section class="map-wrapper">
    <aside class="map-panel" id="controlPanel">
        <header class="panel-header">
            <h2 class="panel-title">Planejamento Georreferenciado</h2>
            <p class="panel-subtitle">Ajuste parâmetros, visualize o enlace e acompanhe o perfil profissional.</p>
        </header>

        <div class="panel-card">
            <h3 class="card-title">Estação Transmissora</h3>
            <dl class="card-grid" id="txSummary">
                <div>
                    <dt>Latitude</dt>
                    <dd id="txLat">-</dd>
                </div>
                <div>
                    <dt>Longitude</dt>
                    <dd id="txLng">-</dd>
                </div>
                <div>
                    <dt>Frequência</dt>
                    <dd id="txFreq">-</dd>
                </div>
                <div>
                    <dt>Modelo</dt>
                    <dd id="txModel">-</dd>
                </div>
                <div>
                    <dt>Azimute</dt>
                    <dd id="txDirection">-</dd>
                </div>
                <div>
                    <dt>Município</dt>
                    <dd id="txMunicipio">-</dd>
                </div>
                <div>
                    <dt>Altitude TX</dt>
                    <dd id="txElevation">-</dd>
                </div>
            </dl>
            <p class="assist-text" id="txClimateInfo">Clima não ajustado para esta localização</p>
        </div>

        <div class="panel-card">
            <h3 class="card-title">Cobertura</h3>
            <label class="form-label" for="radiusInput">Raio de análise (km)</label>
            <div class="input-group">
                <input type="range" id="radiusInput" min="5" max="150" step="5" value="30">
                <span class="input-value" id="radiusValue">30 km</span>
            </div>

            <div class="dual-input">
                <div>
                    <label class="form-label" for="minField">Min dBµV/m</label>
                    <input type="number" id="minField" placeholder="auto" step="0.1">
                </div>
                <div>
                    <label class="form-label" for="maxField">Max dBµV/m</label>
                    <input type="number" id="maxField" placeholder="auto" step="0.1">
                </div>
            </div>

            <div class="unit-toggle-group" role="group" aria-label="Unidade da escala">
                <button type="button" class="btn btn-sm btn-outline-primary active" id="unitDbuv" aria-pressed="true" data-disabled-during-coverage>Campo dBµV/m</button>
                <button type="button" class="btn btn-sm btn-outline-primary" id="unitDbm" aria-pressed="false" data-disabled-during-coverage>Potência dBm</button>
            </div>

            <button class="btn btn-brand w-100" id="btnGenerateCoverage">Gerar cobertura</button>
            <div class="coverage-status-badge" id="coverageStatus" hidden></div>
        </div>

        <div class="panel-card">
            <h3 class="card-title">Visualização</h3>
            <p class="assist-text">Arraste o marcador vermelho para reposicionar a TX. A região circular acompanha o raio selecionado.</p>
            <div class="slider-row">
                <label class="form-label" for="overlayOpacity">Transparência</label>
                <input type="range" id="overlayOpacity" min="0.1" max="1" step="0.05">
                <span id="overlayOpacityValue">0.85</span>
            </div>
        </div>

        <div class="panel-card">
            <h3 class="card-title">Ajustes de Antena</h3>
            <label class="form-label" for="tiltControl">Tilt elétrico TX (°)</label>
            <div class="input-group">
                <input type="range" id="tiltControl" min="-10" max="30" step="0.5" value="0">
                <span class="input-value" id="tiltValue">0°</span>
            </div>
            <label class="form-label" for="directionControl">Azimute da antena (°)</label>
            <div class="input-group">
                <input type="range" id="directionControl" min="0" max="359" step="1" value="0">
                <span class="input-value" id="directionValue">0°</span>
            </div>
            <p class="assist-text">O ganho vertical é recalculado em E/Emax (θ = 0°) e o diagrama horizontal é alinhado ao azimute informado.</p>
        </div>

        <div class="panel-card" id="rt3dPanel" hidden>
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <div>
                    <h3 class="card-title mb-1">Cenário urbano RT3D</h3>
                    <p class="assist-text mb-0">Malha de edificações usada no motor Ray Tracing 3D.</p>
                </div>
                <span class="badge bg-secondary-subtle text-uppercase fw-semibold">Somente RT3D</span>
            </div>
            <dl class="card-grid rt3d-grid">
                <div>
                    <dt>Fonte</dt>
                    <dd id="rt3dSource">-</dd>
                </div>
                <div>
                    <dt>Edificações</dt>
                    <dd id="rt3dCount">-</dd>
                </div>
                <div>
                    <dt>Altura mediana</dt>
                    <dd id="rt3dMedian">-</dd>
                </div>
                <div>
                    <dt>Raio analisado</dt>
                    <dd id="rt3dRadius">-</dd>
                </div>
            </dl>
            <div class="d-flex align-items-center gap-2">
                <button type="button" class="btn btn-outline-primary btn-sm flex-grow-1" id="toggleRt3dLayer" data-disabled-during-coverage>Ocultar malha urbana</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="refreshRt3dLayer" data-bs-toggle="tooltip" title="Recarrega a malha urbana usando os parâmetros atuais." data-disabled-during-coverage>Atualizar cena</button>
                <button type="button" class="btn btn-outline-primary btn-sm" id="toggleRt3dRays" data-disabled-during-coverage>Ocultar raios</button>
            </div>
            <div class="d-flex align-items-center gap-2">
                <a class="btn btn-sm btn-brand flex-grow-1" id="openRt3dViewer" target="_blank" rel="noopener">Abrir em 3D (Cesium)</a>
                <a class="btn btn-sm btn-outline-primary" id="downloadRt3dGeojson" target="_blank" rel="noopener">Exportar GeoJSON</a>
            </div>
            <p class="assist-text mb-0" id="rt3dStatus">Gere a cobertura com o motor RT3D para popular este painel.</p>
        </div>

        <div class="panel-card">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">Recepções</h3>
                <button class="btn btn-sm btn-outline-secondary" type="button" id="btnClearRx">Limpar</button>
            </div>
            <p class="assist-text">Clique no mapa para adicionar pontos RX. Toque em um item para focar ou gerar perfil.</p>
            <ul class="rx-list" id="rxList"></ul>
        </div>

        <div class="panel-card">
            <h3 class="card-title">Resumo de Ganho</h3>
            <dl class="card-grid" id="gainSummary">
                <div>
                    <dt>Ganho base</dt>
                    <dd id="gainBase">-</dd>
                </div>
                <div>
                    <dt>Horizontal (min/max)</dt>
                    <dd id="gainHorizontal">-</dd>
                </div>
                <div>
                    <dt>Vertical (min/max)</dt>
                    <dd id="gainVertical">-</dd>
                </div>
                <div>
                    <dt>Escala</dt>
                    <dd id="fieldScale">-</dd>
                </div>
            </dl>
        </div>

        <div class="panel-card">
            <h3 class="card-title">Perdas P.452</h3>
            <dl class="card-grid loss-grid" id="lossSummary">
                <div>
                    <dt>L_b0p</dt>
                    <dd id="loss-L_b0p">-</dd>
                </div>
                <div>
                    <dt>L_bd</dt>
                    <dd id="loss-L_bd">-</dd>
                </div>
                <div>
                    <dt>L_bs</dt>
                    <dd id="loss-L_bs">-</dd>
                </div>
                <div>
                    <dt>L_ba</dt>
                    <dd id="loss-L_ba">-</dd>
                </div>
                <div>
                    <dt>L_b</dt>
                    <dd id="loss-L_b">-</dd>
                </div>
                <div>
                    <dt>L_b_corr</dt>
                    <dd id="loss-L_b_corr">-</dd>
                </div>
            </dl>
            <p class="assist-text" id="pathTypeInfo"></p>
        </div>

        <div class="panel-card">
            <h3 class="card-title">Referência Central</h3>
            <dl class="card-grid" id="centerSummary">
                <div>
                    <dt>Perda combinada</dt>
                    <dd id="centerLoss">-</dd>
                </div>
                <div>
                    <dt>Potência RX</dt>
                    <dd id="centerPower">-</dd>
                </div>
                <div>
                    <dt>Campo elétrico</dt>
                    <dd id="centerField">-</dd>
                </div>
                <div>
                    <dt>Ganho efetivo</dt>
                    <dd id="centerGain">-</dd>
                </div>
                <div>
                    <dt>Trajetória</dt>
                    <dd id="centerPath">-</dd>
                </div>
                <div>
                    <dt>Distância</dt>
                    <dd id="centerDistance">-</dd>
                </div>
            </dl>
        </div>

        <div class="panel-card">
            <h3 class="card-title">Perfil Profissional</h3>
            <p class="assist-text">Selecione um ponto RX no mapa para visualizar o perfil com Fresnel e curvatura.</p>
            <button class="btn btn-outline-primary w-100" id="btnGenerateProfile" disabled>Gerar perfil do enlace</button>
            <div class="text-center mt-3" id="profileSpinner" hidden>
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Gerando perfil do enlace...</span>
                </div>
            </div>
        </div>

        <div class="panel-card">
            <h3 class="card-title">Ligação TX ↔ RX</h3>
            <dl class="card-grid" id="linkSummary">
                <div>
                    <dt>Distância</dt>
                    <dd id="linkDistance">-</dd>
                </div>
                <div>
                    <dt>Direção</dt>
                    <dd id="linkBearing">-</dd>
                </div>
                <div>
                    <dt>Campo estimado</dt>
                    <dd id="linkField">-</dd>
                </div>
                <div>
                    <dt>Terreno RX</dt>
                    <dd id="linkElevation">-</dd>
                </div>
            </dl>
        </div>

        <div class="colorbar-card" id="colorbarCard" hidden>
            <span class="colorbar-label" id="colorbarLabel">Campo elétrico [dBµV/m]</span>
            <img id="colorbarImage" alt="Colorbar cobertura" />
        </div>
    </aside>

    <div class="map-canvas" id="coverageMapContainer" data-project="{{ project.slug if project else '' }}" data-start-lat="{{ start_coords.lat if start_coords else '' }}"      data-last-coverage-image-url="{{ last_coverage_data.image_url if last_coverage_data and last_coverage_data.image_url else '' }}"
     data-last-coverage-bounds="{{ last_coverage_data.bounds | tojson if last_coverage_data and last_coverage_data.bounds else '' }}"
     data-last-colorbar-image-url="{{ last_coverage_data.colorbar_image_url if last_coverage_data and last_coverage_data.colorbar_image_url else '' }}">
        <div id="coverageMap" class="map-container"></div>
        <div id="coverageSpinner" class="map-loading" hidden>
            <div class="coverage-spinner-icon" aria-hidden="true"></div>
            <span>Gerando cobertura...</span>
        </div>
        <div class="map-floating-card tx-card" id="txLegend" hidden></div>
        <div class="map-floating-card" id="mapTooltip" hidden></div>
    </div>
</section>

<!-- Modal Perfil -->
<div class="modal fade" id="profileModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Perfil de Enlace</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <img id="profileImage" alt="Perfil de enlace" class="profile-image" />
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
    <script src="{{ url_for('static', filename='js/pages/mapa.js') }}"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ maps_api_key }}&libraries=geometry&callback=initCoverageMap" async defer></script>
{% endblock %}
