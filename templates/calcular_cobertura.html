{% extends "layouts/base.html" %}

{% block title %}Calcular Cobertura · ATX Coverage{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/cobertura.css') }}">
{% endblock %}

{% block content %}
<section class="coverage-container">
    <header class="coverage-header">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
            <div>
                <h1>Planejamento de Cobertura</h1>
                <p>Defina parâmetros de propagação, posicionamento e potência para estimar a área de serviço da sua estação.</p>
            </div>
            <div class="d-flex align-items-center gap-3 flex-wrap">
                <span class="badge-soft">Operador: <span id="userName">-</span></span>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="refreshDataBtn">Sincronizar dados</button>
            </div>
        </div>
    </header>

    <div class="coverage-highlight">
        <div>
            <span>Modelos suportados:</span>
            <p class="mb-0 text-muted small">ITU-R P.1546 para enlaces ponto-área · ITU-R P.530 para enlaces ponto-a-ponto.</p>
        </div>
        <div class="text-end">
            <small class="text-muted d-block">Selecione a localização da torre e configure os níveis de potência antes de gerar a cobertura.</small>
        </div>
    </div>

    <form id="coberturaForm">
        <article class="coverage-card">
            <h3>Posicionamento da Estação</h3>
            <div class="coverage-secondary-actions">
                <button type="button" class="btn btn-outline-primary" id="askCoordinatesBtn">Selecionar no mapa</button>
                <button type="button" class="btn btn-outline-secondary" id="openManualCoordinatesBtn">Inserir coordenadas manualmente</button>
            </div>
            <div class="mb-3">
                <label for="coordinates" class="form-label">Coordenadas selecionadas</label>
                <input type="text" class="form-control" id="coordinates" placeholder="Latitude e Longitude" readonly>
            </div>
            <div class="location-summary">
                <span>Município: <strong id="txLocationName">-</strong></span>
                <span>Altitude TX: <strong id="txElevation">-</strong></span>
            </div>
            <div class="form-grid">
                <div>
                    <label for="towerHeight" class="form-label">Altura do centro de fase (m)</label>
                    <input type="number" id="towerHeight" name="towerHeight" class="form-control" min="0" step="any" required>
                </div>
                <div>
                    <label for="rxHeight" class="form-label">Altura do receptor (m)</label>
                    <input type="number" id="rxHeight" name="rxHeight" class="form-control" min="0" step="any" required>
                </div>
            </div>
            <div class="mt-3">
                <button type="button" class="btn btn-outline-primary w-100" onclick="window.location.href='{{ url_for('ui.antena') }}'">
                    Configurar sistema irradiantes
                </button>
            </div>
        </article>

        <article class="coverage-card">
            <h3>Dados de Propagação</h3>
            <div class="form-grid">
                <div>
                    <label for="propagationModel" class="form-label">Ambiente de propagação</label>
                    <select name="propagationModel" id="propagationModel" class="form-select" required>
                        <option value="">Selecione...</option>
                        <option value="modelo1">Urbano</option>
                        <option value="modelo2">Suburbano</option>
                        <option value="modelo3">Rural</option>
                        <option value="modelo4">Floresta</option>
                        <option value="modelo5">Desconhecido</option>
                    </select>
                </div>
                <div>
                    <label for="serviceType" class="form-label">Tipo de serviço</label>
                    <select id="serviceType" name="serviceType" class="form-select" required>
                        <option value="">Selecione...</option>
                        <option value="RadiodifusaoFM">Radiodifusão FM</option>
                        <option value="RadiodifusaoTV">Radiodifusão TV</option>
                        <option value="LinkPontoAPonto">Link ponto a ponto</option>
                        <option value="Redes4G5G">Redes 4G/5G</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
                <div>
                    <label for="Total_loss" class="form-label">Perdas totais do sistema (dB)</label>
                    <input type="number" id="Total_loss" name="Total_loss" class="form-control" min="0" step="any" required>
                </div>
            </div>
            <div class="form-grid">
                <div>
                    <label for="timePercentage" class="form-label">Percentual de tempo p (%), ITU-R P.452</label>
                    <input type="number" id="timePercentage" name="timePercentage" class="form-control" min="0.001" max="50" step="0.1" placeholder="40">
                    <small class="form-text text-muted">Valor entre 0.001 e 50%. Usado para cenários críticos de disponibilidade.</small>
                </div>
                <div>
                    <label for="polarization" class="form-label">Polarização da emissão</label>
                    <select id="polarization" name="polarization" class="form-select">
                        <option value="vertical">Vertical</option>
                        <option value="horizontal">Horizontal</option>
                    </select>
                </div>
                <div>
                    <label for="p452Version" class="form-label">Recomendação ITU-R P.452</label>
                    <select id="p452Version" name="p452Version" class="form-select">
                        <option value="16">Versão 16 (atual)</option>
                        <option value="14">Versão 14 (legado)</option>
                    </select>
                </div>
            </div>
        </article>

        <article class="coverage-card">
            <h3>Especificações Técnicas</h3>
            <div class="form-grid">
                <div>
                    <label for="frequency" class="form-label">Frequência (MHz)</label>
                    <input type="number" id="frequency" name="frequency" class="form-control" min="0" step="any" required>
                </div>
                <div>
                    <label for="transmissionPower" class="form-label">Potência de transmissão (W)</label>
                    <input type="number" id="transmissionPower" name="transmissionPower" class="form-control" min="0" step="any" required>
                </div>
                <div>
                    <label for="antennaGain" class="form-label">Ganho da antena (dBi)</label>
                    <input type="number" id="antennaGain" name="antennaGain" class="form-control" min="0" step="any" required>
                </div>
                <div>
                    <label for="rxGain" class="form-label">Ganho do receptor (dB)</label>
                    <input type="number" id="rxGain" name="rxGain" class="form-control" min="0" step="any" required>
                </div>
                <div>
                    <label for="antennaTilt" class="form-label">Tilt elétrico TX (°)</label>
                    <input type="number" id="antennaTilt" name="antennaTilt" class="form-control" step="0.5" placeholder="0">
                </div>
                <div>
                    <label for="antennaDirection" class="form-label">Azimute da antena (°)</label>
                    <input type="number" id="antennaDirection" name="antennaDirection" class="form-control" min="0" max="359" step="1" placeholder="0">
                </div>
            </div>
        </article>

        <article class="coverage-card">
            <h3>Condições Atmosféricas</h3>
            <div class="form-grid">
                <div>
                    <label for="temperature" class="form-label">Temperatura média (°C)</label>
                    <input type="number" id="temperature" name="temperature" class="form-control" step="0.1" placeholder="20">
                </div>
                <div>
                    <label for="pressure" class="form-label">Pressão atmosférica (hPa)</label>
                    <input type="number" id="pressure" name="pressure" class="form-control" step="0.1" placeholder="1013">
                </div>
                <div>
                    <label for="waterDensity" class="form-label">Densidade de vapor d'água (g/m³)</label>
                    <input type="number" id="waterDensity" name="waterDensity" class="form-control" step="0.1" placeholder="7.5">
                </div>
            </div>
            <p class="assist-text">Valores típicos: 20&nbsp;°C, 1013&nbsp;hPa e 7.5&nbsp;g/m³ (condições padrão ITU). Ajuste para refletir o clima local.</p>
            <button type="button" class="btn btn-outline-secondary" id="loadClimateBtn">Usar dados climáticos estimados (últimos 6 meses)</button>
            <small class="form-text text-muted" id="climateStatus" hidden></small>
        </article>

        <div class="coverage-actions">
            <button type="button" class="btn btn-outline-secondary" id="saveCoverageBtn">Salvar parâmetros</button>
            <button type="button" class="btn btn-brand" id="generateCoverageButton" disabled>Gerar cobertura</button>
            <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='{{ url_for('ui.visualizar_dados_salvos') }}'">Visualizar dados salvos</button>
            <button type="button" class="btn btn-outline-primary" onclick="window.location.href='{{ url_for('ui.mapa') }}'">Abrir mapa de cobertura</button>
        </div>
    </form>
</section>

<button id="backToHomeBtn" class="btn btn-outline-primary fixed-back-button">Voltar ao painel</button>

<!-- Modais -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="successModalLabel">Dados atualizados</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                Configurações salvas com sucesso.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-brand" data-bs-dismiss="modal">Continuar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="errorModalLabel">Não foi possível salvar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                Ocorreu um erro ao gravar os dados. Verifique as informações e tente novamente.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="mapModal" tabindex="-1" aria-labelledby="mapModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mapModalLabel">Clique no mapa para posicionar a torre</h5>
                <button type="button" class="btn-close" id="closeMapModalBtn" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body p-0">
                <div class="map-frame">
                    <div id="map"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-brand" id="saveCoordinatesBtn">Confirmar ponto</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="coordinatesModal" tabindex="-1" aria-labelledby="coordinatesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="coordinatesModalLabel">Inserir coordenadas manualmente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body modal-body-scrollable">
                <div class="coordinates-group">
                    <label class="form-label">Latitude</label>
                    <input type="number" id="latitudeDecimal" class="form-control" min="-90" max="90" placeholder="Decimal" oninput="coverageForm.updateDMS('latitudeDecimal', 'latitudeDegrees', 'latitudeMinutes', 'latitudeSeconds', 'latitudeDirection')">
                    <div class="coordinates-dms">
                        <input type="number" id="latitudeDegrees" class="form-control" min="-90" max="90" placeholder="Graus" oninput="coverageForm.updateDecimal('latitudeDegrees', 'latitudeMinutes', 'latitudeSeconds', 'latitudeDirection', 'latitudeDecimal')">
                        <input type="number" id="latitudeMinutes" class="form-control" min="0" max="59" placeholder="Min" oninput="coverageForm.updateDecimal('latitudeDegrees', 'latitudeMinutes', 'latitudeSeconds', 'latitudeDirection', 'latitudeDecimal')">
                        <input type="number" id="latitudeSeconds" class="form-control" min="0" max="59" placeholder="Seg" oninput="coverageForm.updateDecimal('latitudeDegrees', 'latitudeMinutes', 'latitudeSeconds', 'latitudeDirection', 'latitudeDecimal')">
                        <select id="latitudeDirection" class="form-select" onchange="coverageForm.updateDecimal('latitudeDegrees', 'latitudeMinutes', 'latitudeSeconds', 'latitudeDirection', 'latitudeDecimal')">
                            <option value="N">N</option>
                            <option value="S">S</option>
                        </select>
                    </div>
                </div>
                <div class="coordinates-group mt-3">
                    <label class="form-label">Longitude</label>
                    <input type="number" id="longitudeDecimal" class="form-control" min="-180" max="180" placeholder="Decimal" oninput="coverageForm.updateDMS('longitudeDecimal', 'longitudeDegrees', 'longitudeMinutes', 'longitudeSeconds', 'longitudeDirection')">
                    <div class="coordinates-dms">
                        <input type="number" id="longitudeDegrees" class="form-control" min="-180" max="180" placeholder="Graus" oninput="coverageForm.updateDecimal('longitudeDegrees', 'longitudeMinutes', 'longitudeSeconds', 'longitudeDirection', 'longitudeDecimal')">
                        <input type="number" id="longitudeMinutes" class="form-control" min="0" max="59" placeholder="Min" oninput="coverageForm.updateDecimal('longitudeDegrees', 'longitudeMinutes', 'longitudeSeconds', 'longitudeDirection', 'longitudeDecimal')">
                        <input type="number" id="longitudeSeconds" class="form-control" min="0" max="59" placeholder="Seg" oninput="coverageForm.updateDecimal('longitudeDegrees', 'longitudeMinutes', 'longitudeSeconds', 'longitudeDirection', 'longitudeDecimal')">
                        <select id="longitudeDirection" class="form-select" onchange="coverageForm.updateDecimal('longitudeDegrees', 'longitudeMinutes', 'longitudeSeconds', 'longitudeDirection', 'longitudeDecimal')">
                            <option value="E">E</option>
                            <option value="W">W</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-brand" id="saveManualCoordinatesBtn">Aplicar coordenadas</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="{{ url_for('static', filename='js/pages/cobertura.js') }}"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ maps_api_key }}&libraries=visualization,geometry&callback=initMap" async defer></script>
{% endblock %}
